version: "3.9"
services:
  iriv-combined-api:
    build: .
    container_name: iriv-combined-api
    restart: always
    privileged: true
    ports:
      - "8070:8000"
    devices:
      - "/dev/ttyACM0:/dev/ttyACM0"
      - "/dev/gpiochip0:/dev/gpiochip0"
    environment:
      # --- Modbus/RS485 ---
      SERIAL_PORT: /dev/ttyACM0
      BAUDRATE: "9600"
      PARITY: "N"
      BYTESIZE: "8"
      STOPBITS: "1"
      TIMEOUT_S: "1.0"
      READ_TABLE: "holding"
      REG_START: "0"
      REG_COUNT: "2"
      TEMP_INDEX: "0"
      HUMI_INDEX: "1"
      SCALE_DIV: "10"
      INDOOR_ID: "1"
      OUTDOOR_ID: "2"
      POLL_MS: "1000"

      # --- Roof control (DO) ---
      GPIO_CHIP: /dev/gpiochip0
      LINE_OPEN: "24"
      LINE_CLOSE: "23"
      DEFAULT_PULSE_MS: "800"

      # --- Limit switch (DI1) ---
      LINE_DI1: "5"
      DI1_ACTIVE_HIGH: "true"
      DI1_DEBOUNCE_MS: "50"

      # --- InfluxDB ---
      INFLUX_WRITE_ENABLE: "true"
      INFLUX_URL: "http://influxdb:8086"
      INFLUX_TOKEN: "JYsVtCU6MCzHbiv0oy9v03ciRj7-KPSWYJ3vnR0TNP13h4jAZrbuWo7jCZix5Ku89vo35ZqEdOqEaUqq0W0x7Q=="
      INFLUX_ORG: "Narit"
      INFLUX_BUCKET: "room2"
      INFLUX_MEASUREMENT: "room2"
      INFLUX_TAG_SITE: "ASTROPARK"


networks:
  iot:
    external: true
