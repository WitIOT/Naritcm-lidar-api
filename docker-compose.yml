services:
  naritcm-lidar-api:
    build: .
    container_name: naritcm-lidar-api
    restart: unless-stopped

    ports:
      - "8000:8000"

    # ให้เข้าถึงอุปกรณ์จริงของ IRIV
    privileged: true
    devices:
      - "/dev/ttyACM0:/dev/ttyACM0"
      - "/dev/gpiochip0:/dev/gpiochip0"

    environment:
      # ===== Web/Static =====
      STATIC_DIR: "static"

      # ===== RS485 Modbus =====
      SERIAL_PORT: "/dev/ttyACM0"
      BAUDRATE: "9600"
      PARITY: "N"
      BYTESIZE: "8"
      STOPBITS: "1"
      TIMEOUT_S: "1.0"
      READ_TABLE: "holding"
      REG_START: "0"
      REG_COUNT: "2"
      TEMP_INDEX: "0"
      HUMI_INDEX: "1"
      SCALE_DIV: "10"
      INDOOR_ID: "1"
      OUTDOOR_ID: "2"
      POLL_MS: "1000"

      # ===== GPIO Door/Limit =====
      GPIO_CHIP: "/dev/gpiochip0"
      LINE_OPEN: "25"
      LINE_CLOSE: "24"
      DEFAULT_PULSE_MS: "800"
      LINE_DI1: "17"
      DI1_ACTIVE_HIGH: "true"
      DI1_DEBOUNCE_MS: "50"
  
  sensor-writer:
    build: ./writer
    container_name: sensor-writer
    restart: unless-stopped

    environment:
      SENSOR_API_URL: "http://naritcm-lidar-api:8000/api/sensor"
      POLL_SEC: "1.0"
      HTTP_TIMEOUT_SEC: "2.5"

      # InfluxDB container อื่น (เข้าผ่าน host port)
      INFLUX_URL: "http://192.168.49.8:8086"
      INFLUX_ORG: "Narit"
      INFLUX_BUCKET: "Lidar"
      MEASUREMENT: "room1"

      # ต้องใส่ Token ของ InfluxDB 2.x
      INFLUX_TOKEN: "kTRPZoj7DxBnKY4xDy5kJty6KZhv4BXg5W9JiUGdh9kdaPQr5RF9lic0TYx_3XucOqNHnGlydlTQwFiwuPS-6Q=="

    depends_on:
      - naritcm-lidar-api
